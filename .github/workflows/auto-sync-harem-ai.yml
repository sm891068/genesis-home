name: Auto-Sync Harem AI Library

# è§¸ç™¼æ¢ä»¶ï¼šç•¶ harem-ai-library.js è¢«æ›´æ–°æ™‚
on:
  push:
    paths:
      - 'static/data/harem-ai-library.js'
    branches:
      - main
      - develop
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

jobs:
  sync:
    name: åŒæ­¥å¾Œå®®AIè§’è‰²åº«
    runs-on: ubuntu-latest
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: å®‰è£ä¾è³´
        run: npm ci || npm install
      
      - name: æª¢æŸ¥æ–‡ä»¶å­˜åœ¨
        run: |
          if [ ! -f "static/data/harem-ai-library.js" ]; then
            echo "éŒ¯èª¤: harem-ai-library.js ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ“ æ–‡ä»¶å­˜åœ¨"
      
      - name: çµ±è¨ˆè§’è‰²æ•¸é‡
        id: stats
        run: |
          CHARACTER_COUNT=$(grep -c "^\s\s[a-z_]*_[0-9]*:\s*{" static/data/harem-ai-library.js || echo "0")
          FILE_SIZE=$(stat -f%z static/data/harem-ai-library.js 2>/dev/null || stat -c%s static/data/harem-ai-library.js)
          FILE_SIZE_KB=$((FILE_SIZE / 1024))
          
          echo "character_count=$CHARACTER_COUNT" >> $GITHUB_OUTPUT
          echo "file_size_kb=$FILE_SIZE_KB" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š çµ±è¨ˆä¿¡æ¯ï¼š"
          echo "- è§’è‰²æ•¸é‡: $CHARACTER_COUNT"
          echo "- æ–‡ä»¶å¤§å°: ${FILE_SIZE_KB}KB"
      
      - name: é©—è­‰ JavaScript èªæ³•
        run: |
          node -c static/data/harem-ai-library.js
          echo "âœ“ JavaScript èªæ³•é©—è­‰é€šé"
      
      - name: å‰µå»ºåŒæ­¥æ‘˜è¦
        run: |
          echo "## ğŸ® å¾Œå®®AIè§’è‰²åº«åŒæ­¥å ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š çµ±è¨ˆä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **è§’è‰²ç¸½æ•¸**: ${{ steps.stats.outputs.character_count }} ä½" >> $GITHUB_STEP_SUMMARY
          echo "- **æ–‡ä»¶å¤§å°**: ${{ steps.stats.outputs.file_size_kb }} KB" >> $GITHUB_STEP_SUMMARY
          echo "- **åŒæ­¥æ™‚é–“**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… é©—è­‰ç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
          echo "- [x] æ–‡ä»¶å­˜åœ¨æª¢æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [x] JavaScript èªæ³•é©—è­‰" >> $GITHUB_STEP_SUMMARY
          echo "- [x] è§’è‰²æ•¸é‡çµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ åŒ…å«çš„è§’è‰²ç¨€æœ‰åº¦" >> $GITHUB_STEP_SUMMARY
          echo "- **LR (å‚³èªª)**: 1ä½ - ç‰ç’ƒå¥³ç‹" >> $GITHUB_STEP_SUMMARY
          echo "- **UR (ç©¶æ¥µ)**: 2ä½ - ç´…å§ã€å†°å¿ƒ" >> $GITHUB_STEP_SUMMARY
          echo "- **SSR (ç‰¹ç´š)**: 4ä½ - ç™½ç´ã€ç®—ç›¤æ—ã€å¦–å§¬ã€ç¾…å¥ˆç±³" >> $GITHUB_STEP_SUMMARY
          echo "- **SR (ç¨€æœ‰)**: 2ä½ - æ«»èŠ±ã€é»‘å¯¡å©¦" >> $GITHUB_STEP_SUMMARY
          echo "- **R (ç²¾è‰¯)**: 1ä½ - å°ç´…" >> $GITHUB_STEP_SUMMARY
      
      - name: é€šçŸ¥åŒæ­¥å®Œæˆ
        run: |
          echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
          echo "âœ“ åŒ…å« ${{ steps.stats.outputs.character_count }} ä½è§’è‰²çš„å®Œæ•´AIè³‡æ–™"
          echo "âœ“ æ–‡ä»¶å¤§å°: ${{ steps.stats.outputs.file_size_kb }} KB"
