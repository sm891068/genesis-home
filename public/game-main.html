<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»‘é“å»ºç¯‰ Underworld Architect - éŠæˆ²ä¸»ç•«é¢</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --gold: #d4af37;
            --gold-light: #f4d03f;
            --gold-dark: #b8941f;
            --gold-glow: rgba(212, 175, 55, 0.3);
            --red: #ff2e63;
            --blue: #3498db;
            --purple: #9b59b6;
            --green: #27ae60;
            --bg: #0a0e27;
            --bg-light: #151a35;
            --panel: rgba(10, 14, 39, 0.98);
            --text: #e8e8e8;
            --gray: #888;
            --border: rgba(212, 175, 55, 0.2);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans TC', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            font-size: 14px;
        }
        
        /* ========== å‹•ç•« ========== */
        @keyframes glow { 
            0%, 100% { box-shadow: 0 0 20px var(--gold-glow); } 
            50% { box-shadow: 0 0 40px var(--gold-glow), 0 0 60px rgba(212, 175, 55, 0.1); } 
        }
        
        /* ========== éŠæˆ²ä¸»ç•«é¢ ========== */
        #game-screen {
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: fixed;
            inset: 0;
            z-index: 100;
        }
        
        /* é ‚éƒ¨è³‡æºæ¬„ */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            height: 56px;
            background: rgba(0,0,0,0.5);
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }
        
        .res-box {
            display: flex;
            gap: 28px;
        }
        
        .res-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 80px;
        }
        
        .res-item .label {
            font-size: 9px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }
        
        .res-item .value {
            font-size: 18px;
            font-weight: 700;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(212,175,55,0.3);
        }
        
        .day-box {
            font-size: 13px;
            color: var(--gray);
            background: rgba(212,175,55,0.1);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border);
            font-weight: 500;
            text-align: center;
        }
        
        .day-box span { color: var(--gold); font-weight: 700; font-size: 15px; }
        
        .header-btns {
            display: flex;
            gap: 8px;
        }
        
        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            color: var(--gray);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .header-btn:hover {
            color: var(--gold);
            border-color: var(--gold);
            background: rgba(212,175,55,0.1);
            transform: translateY(-2px);
        }
        
        /* åœ°åœ–å®¹å™¨ */
        .map-container {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            overflow-x: hidden;
            background: radial-gradient(ellipse at center, rgba(212,175,55,0.03) 0%, transparent 70%);
        }
        
        .map-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        
        .grid-cell {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 55px;
        }
        
        .grid-cell:hover {
            background: rgba(212,175,55,0.15);
            border-color: var(--gold);
            transform: scale(0.95);
            box-shadow: 0 0 20px rgba(212,175,55,0.2);
        }
        
        .grid-cell.hq {
            border-color: var(--gold);
            border-width: 2px;
            background: linear-gradient(135deg, rgba(212,175,55,0.2), rgba(212,175,55,0.05));
            box-shadow: 0 0 20px rgba(212,175,55,0.3);
            animation: glow 3s ease-in-out infinite;
        }
        
        .grid-cell .lv {
            position: absolute;
            bottom: 4px;
            right: 6px;
            font-size: 9px;
            color: var(--gold);
            background: rgba(0,0,0,0.7);
            padding: 2px 5px;
            border-radius: 4px;
            font-weight: 700;
        }
        
        /* ========== åº•éƒ¨åŠŸèƒ½æ¬„ ========== */
        .game-footer {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 8px 12px;
            height: 70px;
            background: rgba(0,0,0,0.7);
            border-top: 1px solid var(--border);
            backdrop-filter: blur(10px);
            gap: 4px;
            overflow-x: auto;
            flex-shrink: 0;
            z-index: 99;
        }
        
        .game-footer::-webkit-scrollbar {
            height: 4px;
        }
        
        .game-footer::-webkit-scrollbar-thumb {
            background: rgba(212,175,55,0.3);
            border-radius: 2px;
        }
        
        /* åŠŸèƒ½æŒ‰éˆ• */
        .foot-btn {
            background: transparent;
            border: none;
            color: var(--gray);
            font-size: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 8px 10px;
            position: relative;
            transition: all 0.3s;
            border-radius: 12px;
            min-width: 70px;
            flex-shrink: 0;
            user-select: none;
        }
        
        .foot-btn .icon {
            font-size: 24px;
            transition: all 0.3s;
            filter: grayscale(100%);
        }
        
        .foot-btn:hover {
            background: rgba(212,175,55,0.08);
        }
        
        .foot-btn:hover .icon {
            transform: translateY(-4px);
            filter: grayscale(0%);
        }
        
        .foot-btn.active {
            color: var(--gold);
            background: rgba(212,175,55,0.12);
        }
        
        .foot-btn.active .icon {
            filter: grayscale(0%);
            text-shadow: 0 0 12px rgba(212,175,55,0.5);
        }

        .foot-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .foot-btn:disabled:hover {
            background: transparent;
        }

        .foot-btn:disabled .icon {
            transform: none;
        }
        
        .foot-btn .badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--red);
            color: #fff;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 10px;
            font-weight: 700;
        }

        .foot-btn .label {
            font-size: 10px;
        }

        .foot-btn .disabled-hint {
            font-size: 8px;
            color: #666;
            margin-top: 2px;
        }
        
        /* ========== å³å´å¿«æ·æ¬„ ========== */
        .side-actions {
            position: fixed;
            right: 16px;
            bottom: 76px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 98;
        }
        
        .side-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(212,175,55,0.2), rgba(212,175,55,0.05));
            border: 1.5px solid var(--gold);
            color: var(--gold);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
            position: relative;
        }
        
        .side-btn:hover {
            transform: scale(1.12);
            box-shadow: 0 8px 25px rgba(212,175,55,0.3);
        }
        
        /* ========== åŠŸèƒ½é¢æ¿ï¼ˆçµ±ä¸€å®¹å™¨ï¼‰========== */
        .panel-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            backdrop-filter: blur(5px);
        }
        
        .panel-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-height: 80vh;
            background: var(--panel);
            border-top: 1.5px solid var(--border);
            border-radius: 24px 24px 0 0;
            z-index: 201;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: none;
        }
        
        .panel-header {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(90deg, rgba(212,175,55,0.08) 0%, rgba(212,175,55,0.03) 100%);
        }
        
        .panel-header h3 {
            flex: 1;
            font-size: 18px;
            color: var(--gold);
            text-align: center;
            font-family: 'Noto Serif TC', serif;
            letter-spacing: 1px;
        }
        
        .panel-close-btn {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            transition: all 0.3s;
        }
        
        .panel-close-btn:hover {
            color: var(--gold);
            transform: rotate(90deg);
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        
        /* ========== Toast æç¤º ========== */
        .toast {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.95);
            border: 1.5px solid var(--gold);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            box-shadow: 0 0 30px rgba(212,175,55,0.3);
        }
        .toast.show { opacity: 1; }
        .toast.success { border-color: #27ae60; }
        .toast.error { border-color: #e74c3c; }
        .toast.warning { border-color: #f39c12; }
        
        /* ========== å³å´å»ºç¯‰é¢æ¿ ========== */
        #building-panel-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 300;
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #building-panel-overlay.show {
            display: block;
            opacity: 1;
        }
        
        #building-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 360px;
            height: 100vh;
            background: var(--panel);
            border-left: 1.5px solid var(--border);
            z-index: 301;
            display: none;
            flex-direction: column;
            overflow: hidden;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            box-shadow: -4px 0 20px rgba(0,0,0,0.5);
        }
        
        #building-panel.show {
            display: flex;
            transform: translateX(0);
        }
        
        .building-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(90deg, rgba(212,175,55,0.08) 0%, rgba(212,175,55,0.03) 100%);
            flex-shrink: 0;
        }
        
        .building-panel-header h3 {
            font-size: 18px;
            color: var(--gold);
            font-family: 'Noto Serif TC', serif;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .building-panel-close {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            transition: all 0.3s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        .building-panel-close:hover {
            color: var(--gold);
            background: rgba(212,175,55,0.1);
            transform: rotate(90deg);
        }
        
        .building-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .building-panel-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .building-panel-content::-webkit-scrollbar-thumb {
            background: rgba(212,175,55,0.3);
            border-radius: 3px;
        }
        
        .building-info-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .building-icon-large {
            font-size: 64px;
            text-align: center;
            margin-bottom: 12px;
        }
        
        .building-name-level {
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 8px;
        }
        
        .building-description {
            text-align: center;
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 16px;
            line-height: 1.5;
        }
        
        .building-stats {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            font-size: 13px;
        }
        
        .stat-row .label {
            color: var(--gray);
        }
        
        .stat-row .value {
            color: var(--gold);
            font-weight: 600;
        }
        
        .upgrade-section {
            background: linear-gradient(135deg, rgba(212,175,55,0.08), rgba(212,175,55,0.03));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .upgrade-section h4 {
            font-size: 14px;
            color: var(--gold);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .upgrade-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 12px;
        }
        
        .upgrade-item {
            display: flex;
            justify-content: space-between;
            color: var(--text);
        }
        
        .upgrade-item .label {
            color: var(--gray);
        }
        
        .panel-actions {
            display: flex;
            gap: 8px;
            padding: 16px;
            border-top: 1px solid var(--border);
            background: rgba(0,0,0,0.3);
            flex-shrink: 0;
        }
        
        .panel-btn {
            flex: 1;
            padding: 12px 16px;
            border: 1.5px solid var(--border);
            background: transparent;
            color: var(--text);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .panel-btn:hover {
            background: rgba(212,175,55,0.1);
            border-color: var(--gold);
            color: var(--gold);
            transform: translateY(-2px);
        }
        
        .panel-btn.primary {
            background: linear-gradient(135deg, rgba(212,175,55,0.2), rgba(212,175,55,0.1));
            border-color: var(--gold);
            color: var(--gold);
        }
        
        .panel-btn.primary:hover {
            background: linear-gradient(135deg, rgba(212,175,55,0.3), rgba(212,175,55,0.15));
            box-shadow: 0 4px 15px rgba(212,175,55,0.2);
        }
        
        .panel-btn.danger {
            border-color: var(--red);
            color: var(--red);
        }
        
        .panel-btn.danger:hover {
            background: rgba(255,46,99,0.1);
            border-color: var(--red);
        }
        
        .panel-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .panel-btn:disabled:hover {
            transform: none;
            background: transparent;
            border-color: var(--border);
            color: var(--text);
        }
        
        .build-menu-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .build-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .build-menu-item:hover {
            background: rgba(212,175,55,0.1);
            border-color: var(--gold);
            transform: translateX(4px);
        }
        
        .build-menu-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .build-menu-item.disabled:hover {
            background: rgba(255,255,255,0.03);
            border-color: var(--border);
            transform: none;
        }
        
        .build-menu-icon {
            font-size: 32px;
            flex-shrink: 0;
        }
        
        .build-menu-info {
            flex: 1;
        }
        
        .build-menu-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }
        
        .build-menu-cost {
            font-size: 12px;
            color: var(--gold);
            margin-bottom: 2px;
        }
        
        .build-menu-desc {
            font-size: 11px;
            color: var(--gray);
        }
        
        /* ========== éŸ¿æ‡‰å¼è¨­è¨ˆ ========== */
        @media (max-width: 768px) {
            .game-header { height: 48px; padding: 8px 10px; gap: 8px; }
            .res-box { gap: 12px; }
            .res-item { min-width: 60px; }
            .res-item .value { font-size: 14px; }
            .day-box { font-size: 12px; padding: 6px 12px; min-width: 70px; }
            .header-btn { width: 36px; height: 36px; font-size: 16px; }
            .map-grid { grid-template-columns: repeat(4, 1fr); gap: 6px; }
            .map-container { padding: 10px; }
            .game-footer { height: 62px; padding: 6px 8px; }
            .foot-btn { max-width: 60px; font-size: 8px; gap: 2px; padding: 6px 8px; }
            .foot-btn .icon { font-size: 18px; }
            .side-actions { right: 12px; bottom: 70px; }
            .side-btn { width: 50px; height: 50px; font-size: 20px; }
            .panel-drawer { max-height: 90vh; border-radius: 20px 20px 0 0; }
            
            /* å»ºç¯‰é¢æ¿åœ¨æ‰‹æ©Ÿä¸Šå…¨å± */
            #building-panel {
                width: 100%;
                border-left: none;
                border-top: 1.5px solid var(--border);
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            /* å¹³æ¿ä¸Šç¸®å°å¯¬åº¦ */
            #building-panel {
                width: 320px;
            }
        }
    </style>
</head>
<body>
    <!-- Toast æç¤º -->
    <div id="toast" class="toast"></div>

    <!-- éŠæˆ²ä¸»ç•«é¢ -->
    <div id="game-screen">
        <!-- é ‚éƒ¨è³‡æºæ¬„ -->
        <div class="game-header">
            <div class="res-box">
                <div class="res-item">
                    <span class="label">è³‡é‡‘</span>
                    <span class="value" id="res-money">$0</span>
                </div>
                <div class="res-item">
                    <span class="label">äººæ‰‹</span>
                    <span class="value" id="res-crew">0</span>
                </div>
                <div class="res-item">
                    <span class="label">è²æœ›</span>
                    <span class="value" id="res-rep">0</span>
                </div>
            </div>
            
            <div class="day-box">
                ç¬¬ <span id="game-day">1</span> å¤©
            </div>
            
            <div class="header-btns">
                <button class="header-btn" onclick="gameController.quickSave()" title="å¿«é€Ÿå­˜æª”">ğŸ’¾</button>
                <button class="header-btn" onclick="gameController.backToMenu()" title="è¿”å›ä¸»é¸å–®">ğŸ </button>
            </div>
        </div>
        
        <!-- åœ°åœ–å®¹å™¨ -->
        <div class="map-container">
            <div class="map-grid" id="map-grid">
                <!-- ç”± JavaScript ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- åº•éƒ¨åŠŸèƒ½æ¬„ï¼ˆ10å€‹æŒ‰éˆ•ï¼‰-->
        <div class="game-footer">
            <button class="foot-btn active" data-panel="base" onclick="panelController.show('base')">
                <span class="icon">ğŸ°</span>
                <span class="label">åŸºåœ°</span>
            </button>
            <button class="foot-btn" data-panel="faction" onclick="panelController.show('faction')">
                <span class="icon">âš”ï¸</span>
                <span class="label">æ´¾ç³»</span>
            </button>
            <button class="foot-btn" data-panel="harem" onclick="panelController.show('harem')">
                <span class="icon">ğŸ’ƒ</span>
                <span class="label">å¾Œå®®</span>
            </button>
            <button class="foot-btn" data-panel="partners" onclick="panelController.show('partners')">
                <span class="icon">ğŸ‘¥</span>
                <span class="label">å¤¥ä¼´</span>
            </button>
            <button class="foot-btn" data-panel="team" onclick="panelController.show('team')">
                <span class="icon">ğŸ¯</span>
                <span class="label">éšŠä¼</span>
            </button>
            <button class="foot-btn" data-panel="gang" onclick="panelController.show('gang')" disabled>
                <span class="icon">ğŸ‘‘</span>
                <span class="label">å¹«æœƒ</span>
                <span class="disabled-hint">å¤šäºº</span>
            </button>
            <button class="foot-btn" data-panel="world" onclick="panelController.show('world')" disabled>
                <span class="icon">ğŸŒ</span>
                <span class="label">ä¸–ç•Œ</span>
                <span class="disabled-hint">å¤šäºº</span>
            </button>
            <button class="foot-btn" data-panel="saves" onclick="panelController.show('saves')">
                <span class="icon">ğŸ“</span>
                <span class="label">å­˜æª”</span>
            </button>
            <button class="foot-btn" data-panel="settings" onclick="panelController.show('settings')">
                <span class="icon">âš™ï¸</span>
                <span class="label">è¨­å®š</span>
            </button>
            <button class="foot-btn" data-panel="help" onclick="panelController.show('help')">
                <span class="icon">â“</span>
                <span class="label">å¹«åŠ©</span>
            </button>
        </div>
        
        <!-- å³å´å¿«æ·æ¬„ -->
        <div class="side-actions">
            <button class="side-btn" onclick="gameController.nextTurn()">
                â­ï¸
            </button>
        </div>
    </div>

    <!-- é¢æ¿é®ç½© -->
    <div id="panel-overlay" class="panel-overlay" onclick="panelController.close()"></div>

    <!-- çµ±ä¸€é¢æ¿å®¹å™¨ -->
    <div id="panel-drawer" class="panel-drawer" style="display:none;">
        <div class="panel-header">
            <h3 id="panel-title">é¢æ¿</h3>
            <button class="panel-close-btn" onclick="panelController.close()">âœ•</button>
        </div>
        <div class="panel-content" id="panel-content">
            <!-- å‹•æ…‹è¼‰å…¥å…§å®¹ -->
        </div>
    </div>

    <!-- å»ºç¯‰é¢æ¿é®ç½© -->
    <div id="building-panel-overlay"></div>

    <!-- å»ºç¯‰é¢æ¿ -->
    <div id="building-panel">
        <div class="building-panel-header">
            <h3 id="building-panel-title">å»ºç¯‰è©³æƒ…</h3>
            <button class="building-panel-close">âœ•</button>
        </div>
        <div class="building-panel-content" id="building-panel-content">
            <!-- å‹•æ…‹è¼‰å…¥å…§å®¹ -->
        </div>
        <div id="building-panel-actions" class="panel-actions" style="display:none;">
            <!-- å‹•æ…‹è¼‰å…¥æŒ‰éˆ• -->
        </div>
    </div>

    <!-- ========== è¼‰å…¥æ‰€æœ‰æ¨¡çµ„ï¼ˆæŒ‰é †åºï¼‰========== -->
    
    <!-- 1. æ ¸å¿ƒæ•¸æ“šå±¤ -->
    <script src="/static/core/game-state.js"></script>
    
    <!-- 2. å…±äº« UI å·¥å…· -->
    <script src="/static/ui/shared-ui.js"></script>
    
    <!-- 3. éŠæˆ²æ•¸æ“š -->
    <script src="/static/routes-data.js"></script>
    <script src="/static/partner-data.js"></script>
    <script src="/static/data/ai-personality.js"></script>
    <script src="/static/data/ai-character-logic.js"></script>
    
    <!-- 4. åŠŸèƒ½æ¨¡çµ„ -->
    <script src="/static/modules/base-system.js"></script>
    <script src="/static/modules/harem-system.js"></script>
    <script src="/static/modules/partner-system.js"></script>
    
    <!-- 5. UI æ¨¡çµ„ -->
    <script src="/static/modules/faction-ui.js"></script>
    <script src="/static/modules/team-ui.js"></script>
    <script src="/static/modules/save-ui.js"></script>
    <script src="/static/modules/settings-ui.js"></script>
    <script src="/static/modules/help-ui.js"></script>

    <!-- 6. éŠæˆ²ä¸»æ§åˆ¶å™¨ -->
    <script>
    // ========== éŠæˆ²ä¸»æ§åˆ¶å™¨ ==========
    const gameController = {
        init() {
            console.log('[GameController] åˆå§‹åŒ–éŠæˆ²ç•«é¢');
            
            // æª¢æŸ¥æ˜¯å¦æœ‰éŠæˆ²æ•¸æ“š
            if (!GameState.current.gangName) {
                Toast.error('æ‰¾ä¸åˆ°éŠæˆ²æ•¸æ“šï¼Œè¿”å›ä¸»é¸å–®');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
                return;
            }

            // åˆå§‹åŒ–æ‰€æœ‰ç³»çµ±
            baseSystem.init();
            haremSystem.init();
            partnerSystem.init();
            factionUI.init();
            teamUI.init();
            saveUI.init();
            settingsUI.init();
            helpUI.init();

            // æ¸²æŸ“åœ°åœ–
            this.renderMap();
            
            // æ›´æ–°é ­éƒ¨è³‡æº
            this.updateHeader();

            // é¡¯ç¤ºæ­¡è¿è¨Šæ¯
            Toast.success(`æ­¡è¿å›ä¾†ï¼Œ${GameState.current.gangName}ï¼`);

            console.log('[GameController] éŠæˆ²ç•«é¢åˆå§‹åŒ–å®Œæˆ');
        },

        // æ¸²æŸ“åœ°åœ–
        renderMap() {
            const grid = document.getElementById('map-grid');
            if (!grid) return;

            grid.innerHTML = GameState.current.grid.map((cell, index) => {
                const building = baseSystem.getBuildingType(cell.type);
                const icon = building.icon;
                const isHQ = cell.type === 'hq';
                
                return `
                    <div class="grid-cell ${isHQ ? 'hq' : ''}" onclick="gameController.clickCell(${index})">
                        ${icon}
                        ${cell.level > 0 ? `<div class="lv">Lv.${cell.level}</div>` : ''}
                    </div>
                `;
            }).join('');
        },

        // é»æ“Šæ ¼å­
        clickCell(index) {
            const cell = GameState.current.grid[index];
            if (!cell) return;

            if (cell.type === 'empty') {
                buildingController.showBuildMenu(index);
            } else {
                buildingController.showDetail(index);
            }
        },

        // æ›´æ–°é ­éƒ¨è³‡æº
        updateHeader() {
            document.getElementById('res-money').textContent = formatMoney(GameState.current.money);
            document.getElementById('res-crew').textContent = GameState.current.crew;
            document.getElementById('res-rep').textContent = GameState.current.reputation;
            document.getElementById('game-day').textContent = GameState.current.day;
        },

        // ä¸‹ä¸€å›åˆ
        nextTurn() {
            GameState.current.day++;
            
            // è¨ˆç®—æ—¥æ”¶ç›Š
            const dailyIncome = baseSystem.calculateDailyIncome();
            GameState.current.money += dailyIncome;
            
            // è¨ˆç®—è²æœ›å¢é•·
            GameState.current.reputation += 5;

            // è‡ªå‹•å­˜æª”
            GameState.autoSave();

            // æ›´æ–° UI
            this.updateHeader();

            Toast.success(`ç¬¬ ${GameState.current.day} å¤© | +$${dailyIncome.toLocaleString()}`);
        },

        // å¿«é€Ÿå­˜æª”
        quickSave() {
            const saveData = GameState.save(`å¿«é€Ÿå­˜æª” - ${GameState.current.gangName}`);
            if (saveData) {
                Toast.success('å¿«é€Ÿå­˜æª”æˆåŠŸï¼');
            } else {
                Toast.error('å¿«é€Ÿå­˜æª”å¤±æ•—');
            }
        },

        // è¿”å›ä¸»é¸å–®
        backToMenu() {
            showConfirm('è¿”å›ä¸»é¸å–®å°‡è‡ªå‹•å­˜æª”ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ', () => {
                GameState.autoSave();
                window.location.href = '/';
            });
        }
    };

    // ========== å»ºç¯‰é¢æ¿æ§åˆ¶å™¨ ==========
    const buildingController = {
        currentCellIndex: null,

        // åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
        init() {
            // è¨­ç½®é®ç½©å±¤é»æ“Šäº‹ä»¶
            document.getElementById('building-panel-overlay').addEventListener('click', () => {
                this.close();
            });
            
            // è¨­ç½®é—œé–‰æŒ‰éˆ•äº‹ä»¶
            document.querySelector('.building-panel-close').addEventListener('click', () => {
                this.close();
            });
            
            // ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†é¢æ¿å…§çš„æŒ‰éˆ•é»æ“Š
            document.getElementById('building-panel-actions').addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-action]');
                if (!btn) return;
                
                const action = btn.dataset.action;
                const cellIndex = parseInt(btn.dataset.cellIndex);
                
                if (action === 'upgrade') {
                    this.upgradeBuilding(cellIndex);
                } else if (action === 'demolish') {
                    this.demolishBuilding(cellIndex);
                }
            });
            
            // ä½¿ç”¨äº‹ä»¶å§”è¨—è™•ç†å»ºé€ èœå–®é …ç›®é»æ“Š
            document.getElementById('building-panel-content').addEventListener('click', (e) => {
                const item = e.target.closest('.build-menu-item[data-action="build"]');
                if (!item) return;
                
                const cellIndex = parseInt(item.dataset.cellIndex);
                const buildingType = item.dataset.buildingType;
                
                this.buildBuilding(cellIndex, buildingType);
            });
        },

        // é¡¯ç¤ºå»ºç¯‰è©³æƒ…
        showDetail(cellIndex) {
            this.currentCellIndex = cellIndex;
            const cell = GameState.current.grid[cellIndex];
            if (!cell || cell.type === 'empty') return;

            const building = baseSystem.getBuildingType(cell.type);
            
            // æ›´æ–°æ¨™é¡Œ
            document.getElementById('building-panel-title').innerHTML = `${building.icon} ${building.name}`;
            
            // æ¸²æŸ“å…§å®¹
            const content = document.getElementById('building-panel-content');
            content.innerHTML = this.renderBuildingDetail(cell, building, cellIndex);
            
            // æ¸²æŸ“æ“ä½œæŒ‰éˆ•
            this.renderActions(cell, building, cellIndex);
            
            // é¡¯ç¤ºé¢æ¿
            this.show();
        },

        // é¡¯ç¤ºå»ºé€ èœå–®
        showBuildMenu(cellIndex) {
            this.currentCellIndex = cellIndex;
            
            // æ›´æ–°æ¨™é¡Œ
            document.getElementById('building-panel-title').innerHTML = 'ğŸ—ï¸ å»ºé€ æ–°å»ºç¯‰';
            
            // æ¸²æŸ“å…§å®¹
            const content = document.getElementById('building-panel-content');
            content.innerHTML = this.renderBuildMenu(cellIndex);
            
            // éš±è—åº•éƒ¨æŒ‰éˆ•
            document.getElementById('building-panel-actions').style.display = 'none';
            
            // é¡¯ç¤ºé¢æ¿
            this.show();
        },

        // é¡¯ç¤ºé¢æ¿
        show() {
            const overlay = document.getElementById('building-panel-overlay');
            const panel = document.getElementById('building-panel');
            
            overlay.classList.add('show');
            panel.classList.add('show');
        },

        // é—œé–‰é¢æ¿
        close() {
            const overlay = document.getElementById('building-panel-overlay');
            const panel = document.getElementById('building-panel');
            
            overlay.classList.remove('show');
            panel.classList.remove('show');
            
            this.currentCellIndex = null;
        },

        // æ¸²æŸ“å»ºç¯‰è©³æƒ…
        renderBuildingDetail(cell, building, cellIndex) {
            const DEFENSE_MULTIPLIER_HQ = 50;
            const DEFENSE_MULTIPLIER_NORMAL = 10;
            
            const isMaxLevel = cell.level >= building.maxLevel;
            const upgradeCost = !isMaxLevel ? this.getUpgradeCost(building, cell.level) : 0;
            
            const nextLevelIncome = building.income > 0 && !isMaxLevel
                ? Math.floor(building.income * Math.pow(1.2, cell.level))
                : 0;
            
            const incomeIncrease = nextLevelIncome - cell.income;

            // è¨ˆç®—é˜²ç¦¦å€¼
            const currentDefense = cell.type === 'hq' ? cell.level * DEFENSE_MULTIPLIER_HQ : cell.level * DEFENSE_MULTIPLIER_NORMAL;
            const nextDefense = cell.type === 'hq' ? (cell.level + 1) * DEFENSE_MULTIPLIER_HQ : (cell.level + 1) * DEFENSE_MULTIPLIER_NORMAL;
            const defenseIncrease = nextDefense - currentDefense;

            return `
                <div class="building-info-card">
                    <div class="building-icon-large">${building.icon}</div>
                    <div class="building-name-level">${building.name} - Lv.${cell.level}</div>
                    <div class="building-description">${building.description || ''}</div>
                </div>

                <div class="building-info-card">
                    <h4 style="font-size:13px; color:var(--gold); margin-bottom:12px;">ğŸ“Š ç•¶å‰ç‹€æ…‹</h4>
                    <div class="building-stats">
                        <div class="stat-row">
                            <span class="label">ç­‰ç´š</span>
                            <span class="value">Lv.${cell.level} / ${building.maxLevel}</span>
                        </div>
                        ${building.income > 0 ? `
                            <div class="stat-row">
                                <span class="label">æ—¥ç”¢é‡</span>
                                <span class="value">$${cell.income.toLocaleString()}/å¤©</span>
                            </div>
                        ` : ''}
                        <div class="stat-row">
                            <span class="label">é˜²ç¦¦å€¼</span>
                            <span class="value">+${currentDefense}</span>
                        </div>
                    </div>
                </div>

                ${!isMaxLevel ? `
                    <div class="upgrade-section">
                        <h4>â¬†ï¸ å‡ç´šä¿¡æ¯</h4>
                        <div class="upgrade-info">
                            <div class="upgrade-item">
                                <span class="label">ä¸‹ä¸€ç´š</span>
                                <span style="color:var(--gold);">Lv.${cell.level + 1}</span>
                            </div>
                            <div class="upgrade-item">
                                <span class="label">å‡ç´šæˆæœ¬</span>
                                <span style="color:var(--gold);">$${upgradeCost.toLocaleString()}</span>
                            </div>
                            ${building.income > 0 ? `
                                <div class="upgrade-item">
                                    <span class="label">æ—¥ç”¢å¢åŠ </span>
                                    <span style="color:#27ae60;">+$${incomeIncrease.toLocaleString()}/å¤©</span>
                                </div>
                            ` : ''}
                            <div class="upgrade-item">
                                <span class="label">é˜²ç¦¦å¢åŠ </span>
                                <span style="color:#27ae60;">+${defenseIncrease}</span>
                            </div>
                        </div>
                    </div>
                ` : `
                    <div class="upgrade-section">
                        <h4>âœ… å·²é”æœ€é«˜ç­‰ç´š</h4>
                        <div style="text-align:center; color:var(--gray); font-size:12px; padding:10px 0;">
                            æ­¤å»ºç¯‰å·²é”åˆ°æœ€é«˜ç­‰ç´š Lv.${building.maxLevel}
                        </div>
                    </div>
                `}
            `;
        },

        // è¨ˆç®—å‡ç´šè²»ç”¨ï¼ˆè¼”åŠ©æ–¹æ³•ï¼‰
        getUpgradeCost(building, currentLevel) {
            return typeof building.upgradeCost === 'function' 
                ? building.upgradeCost(currentLevel) 
                : building.upgradeCost;
        },

        // æ¸²æŸ“æ“ä½œæŒ‰éˆ•
        renderActions(cell, building, cellIndex) {
            const actions = document.getElementById('building-panel-actions');
            const isMaxLevel = cell.level >= building.maxLevel;
            const upgradeCost = !isMaxLevel ? this.getUpgradeCost(building, cell.level) : 0;
            const canAfford = GameState.current.money >= upgradeCost;
            const canDemolish = cell.type !== 'hq';

            actions.style.display = 'flex';
            actions.innerHTML = `
                ${!isMaxLevel ? `
                    <button class="panel-btn primary" 
                            data-action="upgrade"
                            data-cell-index="${cellIndex}"
                            ${!canAfford ? 'disabled' : ''}>
                        â¬†ï¸ å‡ç´š ($${upgradeCost.toLocaleString()})
                    </button>
                ` : ''}
                ${canDemolish ? `
                    <button class="panel-btn danger" 
                            data-action="demolish"
                            data-cell-index="${cellIndex}">
                        ğŸ—‘ï¸ æ‹†é™¤
                    </button>
                ` : ''}
            `;
        },

        // æ¸²æŸ“å»ºé€ èœå–®
        renderBuildMenu(cellIndex) {
            const buildableTypes = baseSystem.getBuildableTypes();
            
            return `
                <div style="margin-bottom:16px;">
                    <p style="font-size:13px; color:var(--gray); line-height:1.6;">
                        é¸æ“‡è¦å»ºé€ çš„å»ºç¯‰é¡å‹ã€‚å»ºç¯‰å¯ä»¥ç‚ºä½ æä¾›æ”¶ç›Šã€é˜²ç¦¦æˆ–å…¶ä»–åŠŸèƒ½ã€‚
                    </p>
                </div>

                <div class="build-menu-list">
                    ${buildableTypes.map(type => {
                        const building = baseSystem.getBuildingType(type);
                        const canAfford = GameState.current.money >= building.buildCost;
                        
                        return `
                            <div class="build-menu-item ${canAfford ? '' : 'disabled'}" 
                                 data-action="${canAfford ? 'build' : ''}"
                                 data-cell-index="${cellIndex}"
                                 data-building-type="${type}">
                                <div class="build-menu-icon">${building.icon}</div>
                                <div class="build-menu-info">
                                    <div class="build-menu-name">${building.name}</div>
                                    <div class="build-menu-cost">å»ºé€ æˆæœ¬: $${building.buildCost.toLocaleString()}</div>
                                    <div class="build-menu-desc">
                                        ${building.income > 0 ? `æ—¥ç”¢: $${building.income}/å¤© | ` : ''}
                                        ${building.description}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        },

        // å‡ç´šå»ºç¯‰
        upgradeBuilding(cellIndex) {
            const result = baseSystem.upgrade(cellIndex);
            
            if (result.success) {
                Toast.success(result.message);
                
                // æ›´æ–°é ­éƒ¨è³‡æº
                gameController.updateHeader();
                
                // é‡æ–°æ¸²æŸ“åœ°åœ–
                gameController.renderMap();
                
                // é‡æ–°é¡¯ç¤ºè©³æƒ…
                this.showDetail(cellIndex);
            } else {
                Toast.error(result.message);
            }
        },

        // æ‹†é™¤å»ºç¯‰
        demolishBuilding(cellIndex) {
            const cell = GameState.current.grid[cellIndex];
            const building = baseSystem.getBuildingType(cell.type);
            
            showConfirm(`ç¢ºå®šè¦æ‹†é™¤ ${building.name} Lv.${cell.level} å—ï¼Ÿ`, () => {
                const result = baseSystem.demolish(cellIndex);
                
                if (result.success) {
                    Toast.success(result.message);
                    
                    // æ›´æ–°é ­éƒ¨è³‡æº
                    gameController.updateHeader();
                    
                    // é‡æ–°æ¸²æŸ“åœ°åœ–
                    gameController.renderMap();
                    
                    // é—œé–‰é¢æ¿
                    this.close();
                } else {
                    Toast.error(result.message);
                }
            });
        },

        // å»ºé€ å»ºç¯‰
        buildBuilding(cellIndex, buildingType) {
            const result = baseSystem.build(cellIndex, buildingType);
            
            if (result.success) {
                Toast.success(result.message);
                
                // æ›´æ–°é ­éƒ¨è³‡æº
                gameController.updateHeader();
                
                // é‡æ–°æ¸²æŸ“åœ°åœ–
                gameController.renderMap();
                
                // é¡¯ç¤ºæ–°å»ºç¯‰çš„è©³æƒ…
                this.showDetail(cellIndex);
            } else {
                Toast.error(result.message);
            }
        }
    };

    // ========== é¢æ¿æ§åˆ¶å™¨ ==========
    const panelController = {
        currentPanel: null,

        // é¡¯ç¤ºé¢æ¿
        show(panelName) {
            console.log('[PanelController] é¡¯ç¤ºé¢æ¿:', panelName);

            this.currentPanel = panelName;

            // é¡¯ç¤ºé®ç½©å’Œé¢æ¿
            document.getElementById('panel-overlay').style.display = 'block';
            document.getElementById('panel-drawer').style.display = 'flex';

            // æ›´æ–°æ¨™é¡Œ
            const titles = {
                'base': 'ğŸ° åŸºåœ°ç®¡ç†',
                'faction': 'âš”ï¸ æ´¾ç³»é—œä¿‚',
                'harem': 'ğŸ’ƒ ç§äººå¾Œå®®',
                'partners': 'ğŸ‘¥ å¤¥ä¼´ç®¡ç†',
                'team': 'ğŸ¯ éšŠä¼ç·¨çµ„',
                'gang': 'ğŸ‘‘ å¹«æœƒç³»çµ±',
                'world': 'ğŸŒ ä¸–ç•Œåœ°åœ–',
                'saves': 'ğŸ“ å­˜æª”ç®¡ç†',
                'settings': 'âš™ï¸ è¨­å®š',
                'help': 'â“ å¹«åŠ©'
            };
            document.getElementById('panel-title').textContent = titles[panelName] || 'é¢æ¿';

            // æ¸²æŸ“å°æ‡‰æ¨¡çµ„å…§å®¹
            const content = document.getElementById('panel-content');
            content.innerHTML = ''; // æ¸…ç©º

            switch(panelName) {
                case 'base':
                    baseSystem.renderBasePanel('panel-content');
                    break;
                case 'faction':
                    factionUI.render('panel-content');
                    break;
                case 'harem':
                    haremSystem.renderHaremPanel('panel-content');
                    break;
                case 'partners':
                    partnerSystem.renderPartnerList('panel-content');
                    break;
                case 'team':
                    teamUI.render('panel-content');
                    break;
                case 'gang':
                    content.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">ğŸ‘‘ å¹«æœƒç³»çµ±éœ€è¦å¤šäººæ¨¡å¼<br>æ•¬è«‹æœŸå¾…</div>';
                    break;
                case 'world':
                    content.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">ğŸŒ ä¸–ç•Œåœ°åœ–éœ€è¦å¤šäººæ¨¡å¼<br>æ•¬è«‹æœŸå¾…</div>';
                    break;
                case 'saves':
                    saveUI.render('panel-content');
                    break;
                case 'settings':
                    settingsUI.render('panel-content');
                    break;
                case 'help':
                    helpUI.render('panel-content');
                    break;
                default:
                    content.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">åŠŸèƒ½é–‹ç™¼ä¸­...</div>';
            }

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            this.updateButtonStates();
        },

        // é—œé–‰é¢æ¿
        close() {
            document.getElementById('panel-overlay').style.display = 'none';
            document.getElementById('panel-drawer').style.display = 'none';
            this.currentPanel = null;
            this.updateButtonStates();
        },

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        updateButtonStates() {
            document.querySelectorAll('.foot-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.panel === this.currentPanel) {
                    btn.classList.add('active');
                }
            });
        }
    };

    // ========== éµç›¤å¿«æ·éµ ==========
    document.addEventListener('keydown', (e) => {
        // ESC é—œé–‰é¢æ¿
        if (e.key === 'Escape') {
            // å„ªå…ˆé—œé–‰å»ºç¯‰é¢æ¿
            if (document.getElementById('building-panel').classList.contains('show')) {
                buildingController.close();
            } else {
                panelController.close();
            }
        }
        
        // æ•¸å­—éµ 1-9, 0
        if (e.key >= '0' && e.key <= '9') {
            const panels = ['help', 'base', 'faction', 'harem', 'partners', 'team', 'gang', 'world', 'saves', 'settings'];
            const panelName = panels[parseInt(e.key)];
            if (panelName) panelController.show(panelName);
        }
        
        // N ä¸‹ä¸€å›åˆ
        if (e.key === 'n' || e.key === 'N') {
            gameController.nextTurn();
        }
    });

    // ========== åˆå§‹åŒ– ==========
    document.addEventListener('DOMContentLoaded', () => {
        buildingController.init();
        gameController.init();
    });
    </script>
</body>
</html>
